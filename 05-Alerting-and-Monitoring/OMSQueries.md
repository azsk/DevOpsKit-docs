## OMS Helper Queries

### Contents
- [Overview](OMSQueries.md#overview)
- [Local effective scan result](OMSQueries.md#Local-effective-scan-result)
- [CA Complete Scan Results](OMSQueries.md#ca-complete-scan-results)

--------------------------
### Overview: 
To help team visualize the scan results effectively we have added properties in OMS data objects. 
This will help to filter scan results based on latest module version/access/expiry/baseline etc.


--------------------------
### Local effective scan result

You can validate your local scan with below query by adding Runidentifier (Runidentifier is nothing but the folder name where local scan resides e.g. "20180112_111359_GRS")

``` AIQL
AzSK_CL
| where HasAttestationReadPermissions_b == true and HasRequiredAccess_b == true and IsLatestPSModule_b == true and RunIdentifier_s == "<RunIdentifier>"
```

--------------------------
### CA Complete Scan Results
Following query will help you to get complete results generated by CA scan. 

``` AIQL
let uniqueIdentifiers = AzSK_CommandEvent_CL
| where EventName_s == "Command Completed" and PartialScanIdentifier_s != "" 
| summarize arg_max(TimeGenerated, *) by SubscriptionId 
| project  PartialScanIdentifier_s;
AzSK_CL | join kind= inner (
    uniqueIdentifiers
) on PartialScanIdentifier_s 
| extend ControlStatus = iff(ControlStatus_s == "Passed", "Passed","Failed")
| summarize AggregatedValue = count() by SubscriptionId,ControlStatus
```

--------------------------


